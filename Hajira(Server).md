# Hajira

Hajira is a ML based attendance system, which enables user to setup a seamless attendance system using only 2 IP camera.

## Step-1: Install packages

#### Step-1.1: Download Anaconda/Miniconda and Install it with python 3.8

Firstly, Install Anaconda/Miniconda: open terminal and download miniconda

```
  wget https://repo.anaconda.com/miniconda/Miniconda3-py38_4.10.3-Linux-x86_64.sh
```

#### Step-1.2:

After download Miniconda, install it by typing

```
bash Miniconda3-py38_4.<span class="hljs-number">10.3</span>-Linux-x86_64.sh
```

#### Step-1.3:

Create an Environment (eg: gr)

```
conda create -n gr python=3.8.13
```

#### Step-1.4:

Activate Environment:

```
conda activate gr
```

## Step-2: Install required packages

#### Step-2.1:

* Download requirements.txt from >= [File Link](https://drive.google.com/file/d/1cX3p9hB-SIHsg7dMWFu-_DCxoVRIxO9a/view?usp=sharing)
* Then run the command:

```
pip install requirements.txt
```

#### Step-2.2(Optional):

* If there is an error to import opencv, simply run following command:

```
sudo apt-get update
sudo apt-get install ffmpeg libsm6 libxext6  -y
```

#### Step-2.3:

* Install Supervisor globally:

```
sudo apt install supervisor
sudo apt update
```

## Step-3: Automating Hajira using CronJob
The cron command-line utility is a job scheduler on Unix-like operating systems. Users who set up and maintain software environments use cron to schedule jobs, also known as cron jobs, to run periodically at fixed times, dates, or intervals.

Steps is given below,

* Install ngnix
* Add Logs Directory



#### Step 3.1: Add Logs Directory

We need to make a directory for the any errors in crontab to be logged.<br>

Go to Path:

```
/home/gr/Local_Hajira_lite_Dev/backend
```

Create a logs directory by opening terminal in directory.<br>

Then use the following command:

```
mkdir logs
```

the directory should have a PATH:

```
/home/cpsd/Local_Hajira_lite_Dev1/backend/logs
```

#### Step 3.2: Install nginx
To install nginx globally run the command:
```bash
sudo apt install nginx
```
#### Step-3.3: Setting UP Supervisor

Supervisor allows to monitor and control a number of processes on UNIX-like operating systems.

#### Step-3.4: Configured supervisor file

* Create a supervisor file in `/etc/supervisor/conf.d/` and configure it according to your requirements.
* Type following command to create

```
sudo nano /etc/supervisor/conf.d/gr.conf
```

The file should lool like:

```
[program:gr]
directory=/home/gr/Face-Recognition-API/backend
environment=PATH=/home/gr/miniconda3/envs/gr/bin
command=/home/gr/miniconda3/envs/gr/bin/gunicorn app:app -b localhost:8080
autostart=true
autorestart=true
stderr_logfile=/home/gr/Face-Recognition-API/backend/logs/err.err.log
stdout_logfile=/home/gr/Face-Recognition-API/backend/logs/err.out.log
```
Note: Edit the path as your requirments and make sure that you created logs folder.

#### Step-3.5: To enable the configuration, run the following commands:

```
sudo supervisorctl reread
sudo service supervisor restart
```

This should start a new process. To check the status of all monitored apps, use the following command:

```
sudo supervisorctl status
```

Important: if you make any changes in the code and want to get updated results, you need to restart the supervisor by following commands:

```
sudo supervisorctl restart all
```

## Step-4: Setup nginx

Nginx is an HTTP and reverse proxy server.

Before proceed, make sure that ports like 80 or 8080 are opened and generated by admin of the vm.

#### Step-4.1: Install Nginx in Azure VM

If nginx is not installed in azure vm. Then run: 
```bash
sudo apt install nginx
```

#### Step:-4.2: Write Proxy inside a nginx config file 

Let's define a server block for our flask app.

```
sudo nano /etc/nginx/conf.d/virtual.conf
```

Modify the file as below:
```bash
server {
    listen       80;
    server_name  52.163.71.151;

    location / {
        proxy_pass http://127.0.0.1:8080;
    }
}
```

Note: `server_name` is basically the public ip of the virtual machine and proxy_pass is the refer to the flask app with ports running.

Proxy pass directive must be the same port on which the gunicorn process is listening.

Restart the nginx web server.

```
sudo nginx -t
sudo service nginx restart
```

Congratulations! Now the Flask app is successfully deployed using a configured nginx, gunicorn and supervisor and ready to serve.
